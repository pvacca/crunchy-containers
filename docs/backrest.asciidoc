= pgbackrest Support in Crunchy Container Suite
Crunchy Data Solutions, Inc.
v1.3, {docdate}
:title-logo-image: image:crunchy_logo.png["CrunchyData Logo",align="center",scaledwidth="80%"]

== Description

pgbackrest is a utility that performs a backup, restore, archive
function for a PostgreSQL database.  pgbackrest is written and 
maintained by David Steele, a fellow Crunchy Data collegue!

pgbackrest is described here link:http://www.pgbackrest.org/

Limited support for pgbackrest was added into the Crunchy Container Suite as of version 1.2.5.  The pgbackrest utility is now included in the build
of the crunchy-postgres container.

This document will discuss the design and usage of the pgbackrest features
as implemented so far.

=== pgbackrest Configuration

pgbackrest is configured using a pgbackrest.conf file that is 
mounted into the crunchy-postgres container at /pgconf.

If you place a pgbackrest.conf file within this mounted directory, it
will trigger the use of pgbackrest within the PostgreSQL container
as the archive_command and will turn on the archive_mode to begin
archival.  You still need to define the ARCHIVE_TIMEOUT environment
variable within your container configuration because it is set to
a disable value of 0 by default!

The following changes will be made to the container's postgresql.conf
file:
....
ARCHIVE_MODE=on 
ARCHIVE_TIMEOUT=60 
ARCHIVE_COMMAND='pgbackrest --config=/pgconf/pgbackrest.conf --stanza=db a
rchive-push %p'
....

This requires you use a pgbackrest stanza name of *db* within the
pgbackrest.conf file you mount.

When set, WAL files generated by the database will be written 
out to the /backrestrepo mount point.

=== Performing a Backup

Examples for backrest have been created within the standalone, openshift,
and kubernetes examples directories.

Once you configure the crunchy-postgres container to use pgbackrest, you
will perform a backup using the following commands:
....
docker exec -it backtestdb bash
pgbackrest --stanza=db --config=/pgconf/pgbackrest.conf backup
....

Examine the contents of the mounted /backrestrepo directory to
see the archive files and also the backup files.


== Legal Notices

Copyright Â© 2017 Crunchy Data Solutions, Inc.

CRUNCHY DATA SOLUTIONS, INC. PROVIDES THIS GUIDE "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Crunchy, Crunchy Data Solutions, Inc. and the Crunchy Hippo Logo are trademarks of Crunchy Data Solutions, Inc.

